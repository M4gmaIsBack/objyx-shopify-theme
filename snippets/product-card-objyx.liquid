{%- capture images_json -%}
[
{%- for image in product.images -%}
  "{{ image | image_url: width: 900 }}"{% unless forloop.last %},{% endunless %}
{%- endfor -%}
]
{%- endcapture -%}
{%- assign tag_string = product.tags | join: ',' | downcase -%}

<div
  class="product-card-objyx{% if card_hidden %} is-hidden{% endif %}"
  data-images="{{ images_json | strip_newlines | escape }}"
>
  <div class="product-card-objyx__media">
    <a href="{{ product.url }}" class="product-card-objyx__image-wrapper">
      {%- if product.featured_image -%}
        <img
          src="{{ product.featured_image | image_url: width: 500 }}"
          alt="{{ product.featured_image.alt | escape }}"
          loading="lazy"
          class="product-card-objyx__image"
          data-default-src="{{ product.featured_image | image_url: width: 500 }}"
        >
      {%- endif -%}

      {%- if tag_string contains 'new' or tag_string contains 'nouveau' or tag_string contains 'nouveaute' -%}
        <span class="product-card-objyx__badge">Nouveau</span>
      {%- endif -%}

      {%- if product.compare_at_price_max > product.price -%}
        <span class="product-card-objyx__promo">Promo</span>
      {%- endif -%}
    </a>

    <button
      class="product-card-objyx__add-to-cart"
      title="Ajouter au panier"
      data-product-id="{{ product.id }}"
      data-variant-id="{{ product.first_available_variant.id }}"
      type="button"
    >
      <svg class="product-card-objyx__cart-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="9" cy="21" r="1"></circle>
        <circle cx="20" cy="21" r="1"></circle>
        <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
      </svg>
      <span class="product-card-objyx__add-label">Ajouter</span>
    </button>
  </div>

  <div class="product-card-objyx__content">
    <h3 class="product-card-objyx__title">
      <a href="{{ product.url }}" class="product-card-objyx__title-link">{{ product.title }}</a>
    </h3>

    {%- assign has_color_option = false -%}
    {%- assign color_option = nil -%}
    {%- assign show_meta = false -%}
    {%- for option in product.options_with_values -%}
      {%- assign option_handle = option.name | handleize -%}
      {%- if option_handle == 'color' or option_handle == 'couleur' -%}
        {%- assign has_color_option = true -%}
        {%- assign color_option = option -%}
      {%- endif -%}
      {%- if option_handle == 'materiau-du-jeu-jouet'
        or option_handle == 'matiere-du-jeu-jouet'
        or option_handle == 'material'
        or option_handle == 'materiau'
        or option_handle == 'matiere'
      -%}
        {%- assign show_meta = true -%}
      {%- endif -%}
    {%- endfor -%}

    <div class="product-card-objyx__variants">
      {%- if product.has_only_default_variant -%}
        <span class="product-card-objyx__variant-chip is-unique">Unique</span>
      {%- elsif has_color_option and color_option != nil -%}
        {%- assign option_position = color_option.position -%}
        {%- assign option_index = option_position | minus: 1 -%}
        <div class="product-card-objyx__swatches" aria-label="Couleurs disponibles">
          {%- assign color_count = color_option.values.size -%}
          {%- for value in color_option.values limit: 6 -%}
            {%- assign color_class = value | downcase | replace: ' ', '-' | replace: '/', '-' -%}
            {%- assign variant_image = '' -%}
            {%- assign variant_id = '' -%}
            {%- for variant in product.variants -%}
              {%- if variant.options[option_index] == value and variant.available -%}
                {%- assign variant_id = variant.id -%}
                {%- if variant.featured_image -%}
                  {%- assign variant_image = variant.featured_image | image_url: width: 900 -%}
                {%- endif -%}
                {%- break -%}
              {%- endif -%}
            {%- endfor -%}
            {%- if variant_id == '' -%}
              {%- for variant in product.variants -%}
                {%- if variant.options[option_index] == value -%}
                  {%- assign variant_id = variant.id -%}
                  {%- if variant.featured_image -%}
                    {%- assign variant_image = variant.featured_image | image_url: width: 900 -%}
                  {%- endif -%}
                  {%- break -%}
                {%- endif -%}
              {%- endfor -%}
            {%- endif -%}
            <button
              class="product-card-objyx__swatch product-card-objyx__swatch--{{ color_class }}"
              type="button"
              title="{{ value }}"
              aria-label="{{ value }}"
              data-variant-image="{{ variant_image }}"
              data-variant-id="{{ variant_id }}"
            ></button>
          {%- endfor -%}
          {%- if color_count > 6 -%}
            <span class="product-card-objyx__swatch-count">+{{ color_count | minus: 6 }}</span>
          {%- endif -%}
        </div>
      {%- else -%}
        {%- assign option = product.options_with_values.first -%}
        <div class="product-card-objyx__variant-chips" aria-label="Variantes disponibles">
          {%- assign value_count = option.values.size -%}
          {%- for value in option.values limit: 4 -%}
            <span class="product-card-objyx__variant-chip">{{ value }}</span>
          {%- endfor -%}
          {%- if value_count > 4 -%}
            <span class="product-card-objyx__variant-chip is-more">+{{ value_count | minus: 4 }}</span>
          {%- endif -%}
        </div>
      {%- endif -%}
    </div>

    {%- if show_meta -%}
      <div class="product-card-objyx__meta-fields">
        {%- for option in product.options_with_values -%}
          {%- assign option_handle = option.name | handleize -%}
          {%- if option_handle == 'materiau-du-jeu-jouet'
            or option_handle == 'matiere-du-jeu-jouet'
            or option_handle == 'material'
            or option_handle == 'materiau'
            or option_handle == 'matiere'
          -%}
            <div class="product-card-objyx__meta-spec">
              <span class="product-card-objyx__meta-label">{{ option.name }}:</span>
              <div class="product-card-objyx__meta-values">
                {%- for value in option.values -%}
                  <span class="product-card-objyx__meta-badge">{{ value }}</span>
                {%- endfor -%}
              </div>
            </div>
          {%- endif -%}
        {%- endfor -%}
      </div>
    {%- endif -%}

    <div class="product-card-objyx__pricing">
      {%- if product.compare_at_price_max > product.price -%}
        <span class="product-card-objyx__price-original">{{ product.compare_at_price_max | money }}</span>
      {%- endif -%}
      <span class="product-card-objyx__price">{{ product.price | money }}</span>
      {%- if product.compare_at_price_max > product.price -%}
        {%- assign discount_percent = product.compare_at_price_max
          | minus: product.price
          | times: 100
          | divided_by: product.compare_at_price_max
          | round
        -%}
        <span class="product-card-objyx__discount">-{{ discount_percent }}%</span>
      {%- endif -%}
    </div>
  </div>
</div>

